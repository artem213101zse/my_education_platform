{% extends 'education/base.html' %}

{% block content %}
<div class="container my-5">
    <!-- Путь навигации -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'course_list' %}">Курсы</a></li>
            <li class="breadcrumb-item"><a href="{% url 'course_detail' quiz.module.course.id %}">{{ quiz.module.course.title }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'module_detail' quiz.module.id %}">{{ quiz.module.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Результаты теста</li>
        </ol>
    </nav>

    <h1 class="text-dark fw-bold mb-4">Результаты теста: {{ quiz.title }}</h1>
    <div class="card shadow-lg border-0 rounded-4 p-4 bg-white">
        {% if is_teacher and user.userprofile == module.course.teacher %}
<!-- Для автора: таблица результатов всех пользователей -->
<h3 class="text-dark fw-bold mb-4">Результаты пользователей</h3>
{% if not student_results %}
<p class="text-muted">Ещё никто не прошёл этот тест.</p>
{% else %}
<table class="table table-striped">
    <thead>
        <tr>
            <th>Пользователь</th>
            <th>Правильных ответов</th>
            <th>Всего вопросов</th>
            <th>Процент</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for result in student_results %}
        <tr>
            <td>{{ result.student.user.username }}{% if result.student.is_teacher %} (Учитель){% endif %}</td>
            <td>{{ result.correct }}</td>
            <td>{{ result.total }}</td>
            <td>{{ result.percentage|floatformat:1 }}%</td>
            <td>
                <div class="d-flex gap-2">
                    <a href="{% url 'quiz_user_answers' quiz.id result.student.id %}" class="btn btn-outline-info btn-sm rounded-pill px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye me-2" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                        </svg>
                        Просмотреть ответы
                    </a>
                    <form method="post" action="{% url 'reset_quiz' quiz.id result.student.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-warning btn-sm rounded-pill px-3" onclick="return confirm('Сбросить результаты пользователя?');">
                            Сбросить
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
<a href="{% url 'module_detail' quiz.module.id %}" class="btn btn-secondary rounded-pill px-4 py-2 mt-3">
    Вернуться к модулю
</a>
{% else %}
<!-- Для ученика: его результаты -->
<h3 class="text-dark fw-bold mb-4">Ваши результаты</h3>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Вопрос</th>
            <th>Ваш ответ</th>
            <th>Правильный ответ</th>
            <th>Результат</th>
        </tr>
    </thead>
    <tbody>
    <tbody>
<td>
    asd
</td>
        {% for answer in progress.answers %}
        {% for question in questions %}
        {% if question.id == answer.question_id %}
        <tr class="{% if answer.is_correct %}bg-success{% else %}bg-danger{% endif %} text-white">
            <td>{{ question.text }}</td>
            <td>{{ answer.user_answer }}</td>
            <td>{{ question.correct_answer }}</td>
            <td>{% if answer.is_correct %}Правильно{% else %}Неправильно{% endif %}</td>
        </tr>
        {% endif %}
        {% endfor %}
        {% endfor %}
    </tbody>
</table>
<div class="mt-4">
    <p class="text-dark fw-bold">Результат: {{ progress.correct }} из {{ progress.total }} правильных ответов.</p>
    <p class="text-dark fw-bold">Процент: {{ progress.percentage|floatformat:1 }}%</p>
</div>
<a href="{% url 'module_detail' quiz.module.id %}" class="btn btn-secondary rounded-pill px-4 py-2 mt-3">
    Вернуться к модулю

    
</a>
{% endif %}
    </div>
</div>
{% endblock %}